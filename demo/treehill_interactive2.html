<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FLoD Demo - Treehill</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="js/util.js"></script>
  <script type="importmap">
    {
        "imports": {
            "three": "./lib/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
        }
    }
  </script>
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --accent-color: #06b6d4;
      --active-color: #10b981;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --background: #000000;
      --overlay-bg: rgba(0, 0, 0, 0.8);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius-md: 0.5rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--background);
      height: 100vh;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      position: relative;
    }

    .controls-overlay {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 1rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
    }

    .controls-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--primary-color);
    }

    .control-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .control-key {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.75rem;
      min-width: 2rem;
      text-align: center;
    }

    .control-description {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .controls-overlay {
        top: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        font-size: 0.75rem;
      }
      
    }
  </style>
</head>

<body>
  

  <div class="controls-overlay">
    <div class="controls-title">Controls</div>
    <div class="control-item">
      <div class="control-key">WASD</div>
      <div class="control-description">Move camera</div>
    </div>
    <div class="control-item">
      <div class="control-key">Mouse</div>
      <div class="control-description">Look around</div>
    </div>
    <div class="control-item">
      <div class="control-key">Scroll</div>
      <div class="control-description">Zoom in/out</div>
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
      <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">Level Controls</div>
      <div class="control-item">
        <div class="control-key">1-5</div>
        <div class="control-description">Keyboard: Change level</div>
      </div>
    </div>
  </div>

  <div style="position: fixed; top: 1rem; left: 1rem; background: rgba(0, 0, 0, 0.7); color: white; padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); z-index: 100;">
    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">Level Selection</div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <button id="level-btn-1" onclick="loadLevel(1)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Level 1</button>
      <button id="level-btn-2" onclick="loadLevel(2)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Level 2</button>
      <button id="level-btn-3" onclick="loadLevel(3)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Level 3</button>
      <button id="level-btn-4" onclick="loadLevel(4)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Level 4</button>
      <button id="level-btn-5" onclick="loadLevel(5)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">Level 5</button>
    </div>
  </div>

  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

    const viewer = new GaussianSplats3D.Viewer({
        'cameraUp': [0, -1, -.17],
        'initialCameraPosition': [-5, -1, -1],
        'initialCameraLookAt': [-1.72477, 0.05395, -0.00147],
        'sphericalHarmonicsDegree': 2
    });

    // Scene configuration - different scenes to load
    const scenes = {
        1: {
            path: 'assets/flod_data/treehill/treehill_level1.ksplat',
            name: 'Treehill Level 1',
            options: { 'progressiveLoad': true, 'splatAlphaRemovalThreshold': 20 }
        },
        2: {
            path: 'assets/flod_data/treehill/treehill_level2.ksplat',
            name: 'Treehill Level 2',
            options: { 'progressiveLoad': true, 'splatAlphaRemovalThreshold': 20 }
        },
        3: {
            path: 'assets/flod_data/treehill/treehill_level3.ksplat',
            name: 'Treehill Level 3',
            options: { 'progressiveLoad': true, 'splatAlphaRemovalThreshold': 20 }
        },
        4: {
            path: 'assets/flod_data/treehill/treehill_level4.ksplat',
            name: 'Treehill Level 4',
            options: { 'progressiveLoad': true, 'splatAlphaRemovalThreshold': 20 }
        },
        5: {
            path: 'assets/flod_data/treehill/treehill_level5.ksplat',
            name: 'Treehill Level 5',
            options: { 'progressiveLoad': true, 'splatAlphaRemovalThreshold': 20 }
        }
    };

    let currentSceneIndex = -1;
    let isLoading = false;
    let currentLevel = 0; // Track the actual level number

    // Function to load a scene progressively and remove the previous one
    async function loadSceneProgressive(sceneKey) {
        if (isLoading) {
            console.log('Scene loading already in progress, please wait...');
            return;
        }

        const sceneConfig = scenes[sceneKey];
        if (!sceneConfig) {
            console.error(`Scene ${sceneKey} not found`);
            return;
        }

        isLoading = true;
        console.log(`Loading ${sceneConfig.name}...`);

        try {
            // Load the new scene first (so there's no black screen)
            console.log(`Loading scene: ${sceneConfig.name}`);
            await viewer.addSplatScene(sceneConfig.path, sceneConfig.options);
            
            // Get the new scene index
            const newSceneIndex = viewer.getSceneCount() - 1;
            
            // If there's a previous scene, remove it after the new one is loaded
            if (currentSceneIndex >= 0 && currentSceneIndex < viewer.getSceneCount()) {
                console.log(`Removing previous scene at index ${currentSceneIndex}`);
                await viewer.removeSplatScene(currentSceneIndex);
                
                // After removing a scene, the remaining scene (our new one) is at index 0
                currentSceneIndex = 0;
            } else {
                currentSceneIndex = newSceneIndex;
            }
            
            // Update current level
            currentLevel = sceneKey; // Track the actual level number
            
            console.log(`Scene loaded successfully. Total scenes: ${viewer.getSceneCount()}, Current index: ${currentSceneIndex}, Level: ${currentLevel}`);
            
            // Update UI
            updateLevelInfo();
            
        } catch (error) {
            console.error('Error loading scene:', error);
        } finally {
            isLoading = false;
        }
    }

    // Function to update level info display
    function updateLevelInfo() {
        // Reset all buttons to default style
        for (let i = 1; i <= 5; i++) {
            const btn = document.getElementById(`level-btn-${i}`);
            if (btn) {
                btn.style.background = 'var(--primary-color)';
                btn.style.border = 'none';
            }
        }
        
        // Highlight the current level button
        if (currentLevel > 0) {
            const activeBtn = document.getElementById(`level-btn-${currentLevel}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--active-color)';
                activeBtn.style.border = '2px solid var(--accent-color)';
            }
        }
    }

    // Function to load level (for button clicks)
    function loadLevel(level) {
        console.log(`Button clicked - loading level ${level}`);
        loadSceneProgressive(level);
    }

    // Make loadLevel globally accessible for button onclick handlers
    window.loadLevel = loadLevel;

    // Function to handle key presses
    function handleKeyPress(event) {
        const key = event.key;
        
        // Check if it's a number key 1-5
        if (key >= '1' && key <= '5') {
            const sceneNumber = parseInt(key);
            console.log(`Key ${key} pressed - loading scene ${sceneNumber}`);
            loadSceneProgressive(sceneNumber);
        }
    }

    // Start the rendering loop
    viewer.start();

    // Add event listeners
    document.addEventListener('keydown', handleKeyPress);

    // Initial UI update
    updateLevelInfo();

    console.log('Progressive scene loading demo ready!');
    console.log('Press keys 1-5 to load different scenes progressively');
    console.log('Each new scene will replace the previous one');
    console.log('Or click the level buttons to change scenes interactively');
  </script>
</body>

</html>