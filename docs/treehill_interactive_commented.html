<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FLoD Demo - Treehill Progressive Loading (Commented Version)</title>
  
  <!-- Font loading for better typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Utility script for helper functions -->
  <script type="text/javascript" src="js/util.js"></script>
  
  <!-- Import map for ES6 modules - maps package names to local file paths -->
  <script type="importmap">
    {
        "imports": {
            "three": "./lib/three.module.js",                                    // Three.js 3D graphics library
            "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js" // Gaussian Splatting library for 3D point cloud rendering
        }
    }
  </script>
  
  <style>
    /* CSS Custom Properties (variables) for consistent theming */
    :root {
      --primary-color: #6366f1;           /* Main brand color for buttons and highlights */
      --primary-hover: #4f46e5;          /* Darker shade for hover effects */
      --accent-color: #06b6d4;           /* Accent color for special elements */
      --text-primary: #1e293b;           /* Primary text color */
      --text-secondary: #64748b;         /* Secondary text color */
      --background: #000000;             /* Main background color */
      --overlay-bg: rgba(0, 0, 0, 0.8); /* Semi-transparent overlay background */
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* Large shadow for depth */
      --radius-md: 0.5rem;               /* Medium border radius for rounded corners */
    }

    /* Reset box-sizing for all elements */
    * {
      box-sizing: border-box;
    }

    /* Main body styling */
    body {
      background: var(--background);     /* Black background for 3D scene */
      height: 100vh;                     /* Full viewport height */
      margin: 0;                         /* Remove default margins */
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; /* Modern font stack */
      overflow: hidden;                  /* Hide scrollbars for immersive experience */
      position: relative;                /* Positioning context for overlays */
    }

    /* Right-side controls overlay for camera and level instructions */
    .controls-overlay {
      position: fixed;                   /* Fixed positioning relative to viewport */
      top: 1rem;                         /* 16px from top */
      right: 1rem;                       /* 16px from right */
      background: rgba(0, 0, 0, 0.7);   /* Semi-transparent black background */
      color: white;                      /* White text for contrast */
      padding: 1rem;                     /* 16px internal spacing */
      border-radius: var(--radius-md);   /* Rounded corners */
      font-size: 0.875rem;               /* 14px font size */
      backdrop-filter: blur(10px);       /* Modern backdrop blur effect */
      border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white border */
      z-index: 100;                      /* High z-index to stay above 3D scene */
    }

    /* Title styling for control sections */
    .controls-title {
      font-weight: 600;                  /* Semi-bold font weight */
      margin-bottom: 0.75rem;            /* 12px bottom margin */
      color: var(--primary-color);       /* Primary color for emphasis */
    }

    /* Individual control item styling */
    .control-item {
      display: flex;                     /* Flexbox layout for alignment */
      align-items: center;               /* Center items vertically */
      margin-bottom: 0.5rem;             /* 8px bottom margin between items */
    }

    /* Styling for control key indicators (like WASD) */
    .control-key {
      background: var(--primary-color);  /* Primary color background */
      color: white;                      /* White text */
      padding: 0.25rem 0.5rem;          /* 4px vertical, 8px horizontal padding */
      border-radius: 0.25rem;            /* 4px rounded corners */
      font-size: 0.75rem;               /* 12px font size */
      font-weight: 600;                  /* Semi-bold font weight */
      margin-right: 0.75rem;             /* 12px right margin */
      min-width: 2rem;                   /* Minimum width for consistent sizing */
      text-align: center;                /* Center text within the key indicator */
    }

    /* Description text styling */
    .control-description {
      color: rgba(255, 255, 255, 0.9);  /* Slightly transparent white for hierarchy */
    }

    /* Responsive design for mobile devices */
    @media (max-width: 768px) {
      .controls-overlay {
        top: 0.5rem;                     /* 8px from top on mobile */
        right: 0.5rem;                   /* 8px from right on mobile */
        left: 0.5rem;                    /* 8px from left on mobile */
        font-size: 0.75rem;              /* 12px font size on mobile */
      }
    }
  </style>
</head>

<body>
  
  <!-- Right-side controls panel for camera and level instructions -->
  <div class="controls-overlay">
    <div class="controls-title">Controls</div>
    
    <!-- Camera movement controls -->
    <div class="control-item">
      <div class="control-key">WASD</div>
      <div class="control-description">Move camera</div>
    </div>
    <div class="control-item">
      <div class="control-key">Mouse</div>
      <div class="control-description">Look around</div>
    </div>
    <div class="control-item">
      <div class="control-key">Scroll</div>
      <div class="control-description">Zoom in/out</div>
    </div>
    
    <!-- Level control instructions section -->
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
      <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">Level Controls</div>
      <div class="control-item">
        <div class="control-key">1-5</div>
        <div class="control-description">Keyboard: Change level</div>
      </div>
    </div>
  </div>

  <!-- Left-side level selection panel with interactive buttons -->
  <div style="position: fixed; top: 1rem; left: 1rem; background: rgba(0, 0, 0, 0.7); color: white; padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); z-index: 100;">
    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">Level Selection</div>
    
    <!-- Interactive level buttons - each calls loadLevel() function -->
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <button onclick="loadLevel(1)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Level 1</button>
      <button onclick="loadLevel(2)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Level 2</button>
      <button onclick="loadLevel(3)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Level 3</button>
      <button onclick="loadLevel(4)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Level 4</button>
      <button onclick="loadLevel(5)" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Level 5</button>
    </div>
    
    <!-- Status display showing current level and scene count -->
    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(255, 255, 255, 0.7);">
      Current: <span id="current-level">None</span> | Scenes: <span id="scene-count">0</span>
    </div>
  </div>

  <!-- Main JavaScript module for progressive loading functionality -->
  <script type="module">
    // Import the Gaussian Splatting 3D library for rendering 3D point clouds
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

    // ============================================================================
    // VIEWER CONFIGURATION
    // ============================================================================
    
    // Create the main 3D viewer instance with specific camera settings
    const viewer = new GaussianSplats3D.Viewer({
        'cameraUp': [0, -1, -.17],                    // Camera's "up" vector (slightly tilted)
        'initialCameraPosition': [-5, -1, -1],         // Starting camera position (x, y, z)
        'initialCameraLookAt': [-1.72477, 0.05395, -0.00147], // Point camera looks at initially
        'sphericalHarmonicsDegree': 2                  // Lighting quality for spherical harmonics (0-3)
    });

    // ============================================================================
    // SCENE CONFIGURATION
    // ============================================================================
    
    // Define all available scenes with their properties
    // Each scene represents a different level of detail (LOD) of the treehill
    const scenes = {
        1: {
            path: 'assets/flod_data/treehill/treehill_level1.ksplat',    // File path to level 1 data
            name: 'Treehill Level 1',                                    // Human-readable name
            options: { 
                'progressiveLoad': true,                                 // Enable progressive loading (renders while downloading)
                'splatAlphaRemovalThreshold': 20                         // Alpha threshold for splat visibility
            }
        },
        2: {
            path: 'assets/flod_data/treehill/treehill_level2.ksplat',    // Level 2 - more detail
            name: 'Treehill Level 2',
            options: { 
                'progressiveLoad': true, 
                'splatAlphaRemovalThreshold': 20 
            }
        },
        3: {
            path: 'assets/flod_data/treehill/treehill_level3.ksplat',    // Level 3 - even more detail
            name: 'Treehill Level 3',
            options: { 
                'progressiveLoad': true, 
                'splatAlphaRemovalThreshold': 20 
            }
        },
        4: {
            path: 'assets/flod_data/treehill/treehill_level4.ksplat',    // Level 4 - high detail
            name: 'Treehill Level 4',
            options: { 
                'progressiveLoad': true, 
                'splatAlphaRemovalThreshold': 20 
            }
        },
        5: {
            path: 'assets/flod_data/treehill/treehill_level5.ksplat',    // Level 5 - highest detail
            name: 'Treehill Level 5',
            options: { 
                'progressiveLoad': true, 
                'splatAlphaRemovalThreshold': 20 
            }
        }
    };

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    
    let currentSceneIndex = -1;          // Index of currently loaded scene (-1 = none)
    let isLoading = false;               // Flag to prevent multiple simultaneous loads

    // ============================================================================
    // CORE PROGRESSIVE LOADING FUNCTION
    // ============================================================================
    
    /**
     * Main function that handles progressive loading of scenes
     * This is the heart of the progressive loading system
     * 
     * @param {number} sceneKey - The scene number (1-5) to load
     * @returns {Promise} - Resolves when scene is fully loaded
     */
    async function loadSceneProgressive(sceneKey) {
        // Prevent multiple simultaneous loads to avoid conflicts
        if (isLoading) {
            console.log('Scene loading already in progress, please wait...');
            return;
        }

        // Get the scene configuration for the requested level
        const sceneConfig = scenes[sceneKey];
        if (!sceneConfig) {
            console.error(`Scene ${sceneKey} not found`);
            return;
        }

        // Set loading state and log the operation
        isLoading = true;
        console.log(`Loading ${sceneConfig.name}...`);

        try {
            // ============================================================================
            // SCENE CLEANUP PHASE
            // ============================================================================
            
            // If there's a previous scene loaded, remove it first
            // This ensures only one scene is in memory at a time
            if (viewer.getSceneCount() > 0) {
                console.log(`Removing previous scene at index ${currentSceneIndex}`);
                
                // Remove the previous scene using the viewer's built-in method
                // This properly disposes of GPU resources and memory
                await viewer.removeSplatScene(currentSceneIndex);
                
                // Reset the current scene index since we removed the scene
                currentSceneIndex = -1;
            }
            
            // ============================================================================
            // PROGRESSIVE LOADING PHASE
            // ============================================================================
            
            // Load the new scene with progressive loading enabled
            console.log(`Loading scene: ${sceneConfig.name}`);
            
            // The addSplatScene method with progressiveLoad: true will:
            // 1. Start downloading the scene file in chunks
            // 2. Begin rendering as soon as the first chunk arrives
            // 3. Continue rendering as more chunks download
            // 4. This creates a smooth, progressive loading experience
            await viewer.addSplatScene(sceneConfig.path, sceneConfig.options);
            
            // Update our tracking of the current scene
            // The new scene will be at the last index of the scenes array
            currentSceneIndex = viewer.getSceneCount() - 1;
            
            // Log successful completion
            console.log(`Scene loaded successfully. Total scenes: ${viewer.getSceneCount()}, Current index: ${currentSceneIndex}`);
            
            // Update the UI to reflect the new state
            updateLevelInfo();
            
        } catch (error) {
            // Handle any errors that occur during loading
            console.error('Error loading scene:', error);
        } finally {
            // Always reset the loading state, even if there was an error
            isLoading = false;
        }
    }

    // ============================================================================
    // UI UPDATE FUNCTIONS
    // ============================================================================
    
    /**
     * Updates the level information display in the UI
     * Shows current level and total scene count
     */
    function updateLevelInfo() {
        // Get references to the UI elements
        const currentLevelSpan = document.getElementById('current-level');
        const sceneCountSpan = document.getElementById('scene-count');
        
        // Update the current level display
        if (currentSceneIndex >= 0 && currentSceneIndex < viewer.getSceneCount()) {
            // Show which level is currently loaded
            currentLevelSpan.textContent = `Level ${currentSceneIndex + 1}`;
        } else {
            // Show "None" if no scene is loaded
            currentLevelSpan.textContent = 'None';
        }
        
        // Update the total scene count (should always be 0 or 1 with our system)
        sceneCountSpan.textContent = viewer.getSceneCount();
    }

    // ============================================================================
    // USER INTERACTION FUNCTIONS
    // ============================================================================
    
    /**
     * Function called by button clicks to load a specific level
     * This is the entry point for button-based level selection
     * 
     * @param {number} level - The level number to load (1-5)
     */
    function loadLevel(level) {
        console.log(`Button clicked - loading level ${level}`);
        // Delegate to the main progressive loading function
        loadSceneProgressive(level);
    }

    // Make loadLevel globally accessible so HTML button onclick handlers can call it
    // This is necessary because the function is defined in a module scope
    window.loadLevel = loadLevel;

    /**
     * Handles keyboard input for level selection
     * Provides an alternative to button clicks for power users
     * 
     * @param {KeyboardEvent} event - The keyboard event object
     */
    function handleKeyPress(event) {
        const key = event.key;
        
        // Check if the pressed key is a number 1-5
        if (key >= '1' && key <= '5') {
            const sceneNumber = parseInt(key);
            console.log(`Key ${key} pressed - loading scene ${sceneNumber}`);
            
            // Delegate to the main progressive loading function
            loadSceneProgressive(sceneNumber);
        }
    }

    // ============================================================================
    // INITIALIZATION AND EVENT SETUP
    // ============================================================================
    
    // Start the viewer's rendering loop
    // This begins the continuous rendering of the 3D scene
    viewer.start();

    // Add keyboard event listener for level selection
    // Listens for key presses on the entire document
    document.addEventListener('keydown', handleKeyPress);

    // Initialize the UI to show the starting state
    updateLevelInfo();

    // ============================================================================
    // CONSOLE LOGGING FOR DEBUGGING
    // ============================================================================
    
    console.log('Progressive scene loading demo ready!');
    console.log('Press keys 1-5 to load different scenes progressively');
    console.log('Each new scene will replace the previous one');
    console.log('Or click the level buttons to change scenes interactively');
    
    // ============================================================================
    // PROGRESSIVE LOADING EXPLANATION
    // ============================================================================
    
    /*
     * HOW PROGRESSIVE LOADING WORKS:
     * 
     * 1. CHUNKED DOWNLOADING:
     *    - Scene files are downloaded in small chunks (256KB by default)
     *    - Each chunk contains a portion of the 3D point cloud data
     *    
     * 2. IMMEDIATE RENDERING:
     *    - As soon as the first chunk arrives, rendering begins
     *    - Users see the scene appear progressively, not all at once
     *    
     * 3. CONTINUOUS IMPROVEMENT:
     *    - Each new chunk adds more detail to the scene
     *    - Quality improves as more data arrives
     *    
     * 4. MEMORY EFFICIENCY:
     *    - Only one scene is in memory at a time
     *    - Previous scenes are properly disposed of
     *    
     * 5. USER EXPERIENCE:
     *    - No waiting for full download completion
     *    - Immediate visual feedback
     *    - Smooth transitions between levels
     *    
     * BENEFITS:
     *    - Faster perceived loading times
     *    - Better user engagement
     *    - Reduced memory usage
     *    - Smooth level transitions
     */
  </script>
</body>

</html>
