<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3D Gaussian Splats - 58e7 Scene</title>
  <script type="text/javascript" src="js/util.js"></script>
  <script type="importmap">
    {
        "imports": {
            "three": "./lib/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
        }
    }
  </script>
  <style>
    /* Original body styling */
    body {
      background-color: #000000;
      height: 100vh;
      margin: 0px;
      font-family: Arial, sans-serif;  /* Added: Better font for UI elements */
    }

    /* NEW: Level selection control panel */
    #levelControls {
      position: absolute;        /* Position over the 3D scene */
      top: 20px;                /* 20 pixels from top */
      left: 20px;               /* 20 pixels from left */
      z-index: 1000;            /* Ensure it appears above 3D content */
      background: rgba(0, 0, 0, 0.8);  /* Semi-transparent black background */
      padding: 15px;            /* Space inside the panel */
      border-radius: 8px;       /* Rounded corners */
      color: white;             /* White text */
      min-width: 200px;         /* Minimum width for buttons */
    }

    /* NEW: Title for the control panel */
    #levelControls h3 {
      margin: 0 0 15px 0;       /* No top margin, 15px bottom margin */
      font-size: 16px;          /* Slightly larger font */
      color: #ffd700;           /* Gold color for the title */
    }

    /* NEW: Styling for level selection buttons */
    .level-button {
      display: block;           /* Each button takes full width */
      width: 100%;              /* Full width of parent */
      margin: 5px 0;            /* 5px vertical margin between buttons */
      padding: 8px 12px;        /* 8px top/bottom, 12px left/right padding */
      background: #333;         /* Dark gray background */
      color: white;             /* White text */
      border: 1px solid #555;   /* Gray border */
      border-radius: 4px;       /* Slightly rounded corners */
      cursor: pointer;          /* Hand cursor on hover */
      transition: all 0.3s ease; /* Smooth transition for hover effects */
    }

    /* NEW: Hover effect for buttons */
    .level-button:hover {
      background: #555;         /* Lighter gray on hover */
      border-color: #777;       /* Lighter border on hover */
    }

    /* NEW: Active/selected button styling */
    .level-button.active {
      background: #ffd700;      /* Gold background for active button */
      color: #000;              /* Black text for contrast */
      border-color: #ffd700;    /* Gold border */
    }

    /* NEW: Disabled button styling (when loading) */
    .level-button:disabled {
      background: #222;         /* Very dark gray */
      color: #666;              /* Dimmed text */
      cursor: not-allowed;      /* Not-allowed cursor */
      border-color: #333;       /* Dark border */
    }

    /* NEW: Loading indicator */
    #loadingIndicator {
      display: none;            /* Hidden by default */
      color: #ffd700;           /* Gold color */
      font-style: italic;       /* Italic text */
      margin-top: 10px;         /* Space above the indicator */
      text-align: center;       /* Center the text */
    }

    /* NEW: Information display panel */
    #info {
      position: absolute;       /* Position over the 3D scene */
      bottom: 20px;             /* 20 pixels from bottom */
      left: 20px;               /* 20 pixels from left */
      z-index: 1000;            /* Above 3D content */
      background: rgba(0, 0, 0, 0.8);  /* Semi-transparent background */
      padding: 10px;            /* Space inside */
      border-radius: 8px;       /* Rounded corners */
      color: white;             /* White text */
      font-size: 12px;          /* Smaller font size */
    }
  </style>
</head>

<body>
      <!-- NEW: Level selection control panel -->
      <div id="levelControls">
        <h3>LOD Level Selection</h3>
        <!-- Each button represents a different LOD level -->
        <button class="level-button" data-level="1">Level 1 (10k iterations)</button>
        <button class="level-button" data-level="2">Level 2 (15k iterations)</button>
        <button class="level-button" data-level="3">Level 3 (20k iterations)</button>
        <button class="level-button" data-level="4">Level 4 (25k iterations)</button>
        <button class="level-button active" data-level="5">Level 5 (30k iterations)</button>
        <!-- Loading indicator (hidden by default) -->
        <div id="loadingIndicator">Loading...</div>
      </div>

      <!-- NEW: Information display panel -->
      <div id="info">
        <div>Current Level: <span id="currentLevel">5</span></div>
        <div>Iterations: <span id="currentIterations">30k</span></div>
        <div>Scale Constraint: <span id="scaleConstraint">None</span></div>
      </div>

      <script type="module">
      import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

      // Get URL parameters (existing code)
      const urlParams = new URLSearchParams(window.location.search);
      const mode = parseInt(urlParams.get('mode')) || 0;
      
      // NEW: Variables to track current state
      let currentLevel = 5;           // Start with level 5
      let currentScene = null;        // Reference to current 3D scene
      let isLoading = false;          // Loading state flag

      // Create the 3D viewer (existing code)
      const viewer = new GaussianSplats3D.Viewer({
        'cameraUp': [0, -1, -0.54],
        'initialCameraPosition': [-3.15634, -0.16946, -0.51552],
        'initialCameraLookAt': [1.52976, 2.27776, 1.65898],
        'sphericalHarmonicsDegree': 2
      });

      // NEW: Configuration for each LOD level (58e7 scene paths)
      const levelConfig = {
        1: { iterations: '10k', scale: '70% reduction', path: 'assets/flod_data/58e7/point_cloud/lod_1_iteration_10000/point_cloud' },
        2: { iterations: '15k', scale: '50% reduction', path: 'assets/flod_data/58e7/point_cloud/lod_2_iteration_15000/point_cloud' },
        3: { iterations: '20k', scale: '30% reduction', path: 'assets/flod_data/58e7/point_cloud/lod_3_iteration_20000/point_cloud' },
        4: { iterations: '25k', scale: '15% reduction', path: 'assets/flod_data/58e7/point_cloud/lod_4_iteration_25000/point_cloud' },
        5: { iterations: '30k', scale: 'None', path: 'assets/flod_data/58e7/point_cloud/lod_5_iteration_30000/point_cloud' }
      };

      // NEW: Function to update the information display
      function updateInfo() {
        const config = levelConfig[currentLevel];
        document.getElementById('currentLevel').textContent = currentLevel;
        document.getElementById('currentIterations').textContent = config.iterations;
        document.getElementById('scaleConstraint').textContent = config.scale;
      }

      // NEW: Function to highlight the active button
      function setActiveButton(level) {
        // Remove 'active' class from all buttons
        document.querySelectorAll('.level-button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add 'active' class to selected button
        const selectedBtn = document.querySelector(`[data-level="${level}"]`);
        if (selectedBtn) {
          selectedBtn.classList.add('active');
        }
      }

      // NEW: Function to show/hide loading state
      function setLoadingState(loading) {
        isLoading = loading;
        const indicator = document.getElementById('loadingIndicator');
        const buttons = document.querySelectorAll('.level-button');
        
        if (loading) {
          indicator.style.display = 'block';        // Show loading text
          buttons.forEach(btn => btn.disabled = true);  // Disable all buttons
        } else {
          indicator.style.display = 'none';          // Hide loading text
          buttons.forEach(btn => btn.disabled = false); // Enable all buttons
        }
      }

      // NEW: Main function to load a different LOD level
      async function loadLevel(level) {
        if (isLoading) return;  // Don't load if already loading
        
        setLoadingState(true);   // Show loading state
        currentLevel = level;    // Update current level
        
        try {
          const config = levelConfig[level];
          const fileExtension = mode ? '.ksplat' : '.ply';  // Choose file format based on mode
          const path = config.path + fileExtension;
          
          console.log(`Loading level ${level} from: ${path}`);
          
          // Remove current scene if it exists
          if (currentScene) {
            viewer.removeSplatScene(currentScene);
            currentScene = null;
          }
          
          // Add new scene
          currentScene = await viewer.addSplatScene(path, {
            'progressiveLoad': false
          });
          
          // Update UI
          setActiveButton(level);
          updateInfo();
          
          console.log(`Successfully loaded level ${level}`);
          
        } catch (error) {
          console.error(`Failed to load level ${level}:`, error);
          alert(`Failed to load level ${level}. Please ensure the file exists.`);
        } finally {
          setLoadingState(false);  // Hide loading state
        }
      }

      // NEW: Add click event listeners to all level buttons
      document.querySelectorAll('.level-button').forEach(btn => {
        btn.addEventListener('click', () => {
          const level = parseInt(btn.dataset.level);
          if (level !== currentLevel) {  // Only load if different level
            loadLevel(level);
          }
        });
      });

      // Initialize with default level (existing code, but modified)
      let path = levelConfig[currentLevel].path + (mode ? '.ksplat' : '.ply');
      
      viewer.addSplatScene(path, {
        'progressiveLoad': false
      })
      .then((scene) => {
          currentScene = scene;  // Store reference to scene
          viewer.start();
          updateInfo();          // Update info display
      })
      .catch((error) => {
          console.error('Failed to load initial scene:', error);
          alert('Failed to load initial scene. Please check the console for details.');
      });
    </script>
</body>

</html>
